---
import ElectricityPriceCard from '../../components/ElectricityPriceCard.vue';
import Layout from '../../layouts/Layout.astro';
import ComsumptionGuidance from '../../components/ConsumptionGuidance.vue';
import PriceCards from '../../components/PriceCards.vue';
import PriceChart from '../../components/PriceChart.vue';
import PriceList from '../../components/PriceList.vue';
import { Check, Siren, Lightbulb, ChartColumnBig } from '@lucide/astro';
import SubscribeForm from '../../components/SubscribeForm.vue';
import GlobalPriceSwitch from '../../components/GlobalPriceSwitch.vue';

// Construir URL absoluta (funciona tanto en dev como en producci√≥n)
const site = import.meta.env.SITE || 'http://localhost:4321';
const apiUrl = new URL('/api/prices', site);

// Hacer fetch con URL absoluta
const response = await fetch(apiUrl, {
  headers: { Accept: 'application/json' },
});
if (!response.ok) {
  throw new Error(`Error al cargar los datos: ${response.status}`);
}
const priceData = await response.json();

// Obtener precio actual seg√∫n la hora
const currentHour = new Date().getHours();
const actualPrice =
  priceData.prices.find((item) => {
    const [start, end] = item.hour.split(' - ');
    const startHour = parseInt(start.split(':')[0]);
    const endHour = parseInt(end.split(':')[0]);
    if (startHour < endHour)
      return currentHour >= startHour && currentHour < endHour;
    return currentHour >= startHour || currentHour < endHour;
  })?.price ?? priceData.currentPrice;

// Formatear fecha
const formattedDate = new Intl.DateTimeFormat('es-ES', {
  day: '2-digit',
  month: '2-digit',
  year: 'numeric',
  hour: '2-digit',
  minute: '2-digit',
}).format(new Date());
---

<Layout
  title="Precio de la luz hoy en Espa√±a - Tarifas por hora actualizadas"
  description="Consulta el precio de la luz por horas hoy en Espa√±a. Ahorra planificando tus consumos con las tarifas m√°s baratas del d√≠a.">
  <div class="text-primary-100 mt-space-l">
    <h1 class="fw-700 text-neutral-50">
      Precio de la luz hoy por horas en Espa√±a ‚Äì {formattedDate}
    </h1>
    <p class="mt-space-m">
      Consulta el precio de la luz hoy por horas en Espa√±a. Te mostramos las
      franjas horarias m√°s baratas y m√°s caras para ayudarte a ahorrar en tu
      factura el√©ctrica.
    </p>
    <div class="mt-space-m">
      <p>Puedes consultar el precio de ma√±ana</p> <GlobalPriceSwitch/>
     </div>
    <h2 class="mt-space-xl text-neutral-50">
      ¬øQuieres calcular cu√°nto te cuesta usar tus electrodom√©sticos hoy?
    </h2>
    <p class="mt-space-s">
      üëâ Usa nuestra <a href="/">calculadora de consumo</a>
      para saber cu√°nto te cuesta usar tus electrodom√©sticos hoy.
    </p>
    <div class="mt-space-xl">
      <ElectricityPriceCard client:load />
    </div>
    <div>
      <ComsumptionGuidance client:load />
    </div>

    <hr class="text-neutral-400 my-space-2xl" />
    <h2 class="fw-700 text-neutral-50 mb-space-s">
      Evoluci√≥n precio del kWh Espa√±a
    </h2>
    <p class="mb-space-xl text-primary-100">
      Consulta la evoluci√≥n del precio del kWh por horas en Espa√±a y descubre
      cu√°les son las franjas m√°s econ√≥micas del d√≠a para ahorrar en tu consumo
      el√©ctrico.
    </p>
    <PriceCards client:only />
    <div
      class="bg-primary-900 px-space-l py-space-l mt-space-s mb-space-3xl rounded-sm">
      <PriceChart client:only class="desktop-only" />
      <PriceList client:only class="mobile-only" />
    </div>
    <div class="mt-space-xl text-neutral-50 bg-primary-900 p-space-l rounded-md">
    <div class="newsletter-header text-primary-50">
      <h2>‚ö°¬°No te pierdas las horas m√°s baratas de luz!</h2>
      <p class="subtitle mt-space-xs">Recibe cada d√≠a un correo con:</p>
      <ul role="list" class="mt-space-m flow">
        <li class="d-flex">
          <Check color="var(--accent-500)" /> Las <strong>3 horas clave</strong>
          para ahorrar en tu factura
        </li>
        <li class="d-flex">
          <Siren color="var(--red-500)" /> Alertas de <strong
            >picos de precio</strong
          > que debes evitar
        </li>
        <li class="d-flex">
          <Lightbulb color="var(--orange-300)" /> Consejos pr√°cticos para cada electrodom√©stico
        </li>
        <li class="d-flex">
          <ChartColumnBig color="var(--primary-200)" /> Comparativas de ahorro <strong
            >personalizadas</strong>
        </li>
      </ul>
      <div class="mt-space-m">
        <SubscribeForm client:load />
      </div>
    </div>
  </div> 
  </div>

  <style>
    hr {
      opacity: 0.2;
    }
    .desktop-only {
      display: block;
    }

    .mobile-only {
      display: none;
    }

    @media (max-width: 767px) {
      .desktop-only {
        display: none !important;
      }

      .mobile-only {
        display: block !important;
      }
    }

    .newsletter-header {
      max-width: 800px;
      border-radius: 8px;
    }
  </style>
</Layout>
