---
import { navigation as navDefault } from "../constant";
import Logo from "../assets/logo-calcula-tu-luz.svg";
import LogoMobile from "../assets/logo-mobile.svg";

const currentPath = Astro.url.pathname;

const navigation = navDefault.filter((item) => {
  if (item.onlyTips && currentPath === "/") {
    return false;
  }
  return true;
});

// Helper para detectar si un item o sus hijos est치n activos
function isItemActive(item: any): boolean {
  if (item.children) {
    return item.children.some((child: any) => 
      child.url === "/" ? currentPath === "/" : currentPath.startsWith(child.url)
    );
  }
  return item.url === "/" ? currentPath === "/" : currentPath.startsWith(item.url);
}
---

<header class="header">
  <div class="header__bar">
    <div class="container">
      <div class="header__content d-flex">
        <!-- Logo -->
        <div class="logo-wrapper">
          <a aria-label="Logo de calculatuluz.es" href="/">
            <span class="logo-desktop">
              <Logo width={160} />
            </span>
            <span class="logo-mobile">
              <LogoMobile width={45} />
            </span>
          </a>
        </div>

        <!-- Navigation (Desktop y Mobile) -->
        <nav aria-label="Main navigation" class="nav">
          <ul class="nav__list" role="menubar">
            {
              navigation.map((item) => {
                const hasChildren = item.children && item.children.length > 0;
                const isActive = isItemActive(item);
                
                return (
                  <li role="none" class={hasChildren ? 'has-dropdown' : ''}>
                    {hasChildren ? (
                      <>
                        <button
                          type="button"
                          role="menuitem"
                          aria-haspopup="true"
                          aria-expanded="false"
                          class={`nav__link nav__link--dropdown text-neutral-50 ${
                            isActive ? "nav__link--active fw-500" : ""
                          }`}
                        >
                          {item.title}
                          <svg class="dropdown-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                          {item.children.map((child: any) => {
                            const isChildActive = child.url === "/" 
                              ? currentPath === "/" 
                              : currentPath.startsWith(child.url);
                            return (
                              <li role="none">
                                <a
                                  href={child.url}
                                  role="menuitem"
                                  aria-current={isChildActive ? "page" : undefined}
                                  class={`dropdown-link ${isChildActive ? "dropdown-link--active" : ""}`}
                                >
                                  {child.title}
                                </a>
                              </li>
                            );
                          })}
                        </ul>
                      </>
                    ) : (
                      <a
                        href={item.url}
                        role="menuitem"
                        aria-current={isActive ? "page" : undefined}
                        class={`nav__link text-neutral-50 ${
                          isActive ? "nav__link--active fw-500" : ""
                        }`}
                      >
                        {item.title}
                      </a>
                    )}
                  </li>
                );
              })
            }
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

<style>
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background-color: var(--primary-900);
  }

  .header__bar {
    padding-block: var(--space-s);
  }

  .header__content {
    --horizontal-alignment: space-between;
    flex-wrap: nowrap;
  }

  /* Logo */
  .logo-wrapper {
    flex-shrink: 0;
  }

  .logo-desktop {
    display: inline-block;
  }
  
  .logo-mobile {
    display: none;
  }

  .logo-wrapper a {
    display: inline-flex;
    align-items: center;
  }

  .logo-wrapper svg {
    height: auto;
  }

  /* Navigation */
  .nav {
    overflow: visible;
  }

  .nav__list {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: var(--space-xs);
    overflow-y: visible;
    
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  .nav__list::-webkit-scrollbar {
    display: none;
  }

  .nav__list {
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }

  .nav__list li {
    flex-shrink: 0;
    position: relative;
  }

  .nav__link {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: var(--space-2xs) var(--space-s);
    white-space: nowrap;
    transition: all 0.2s ease;
    font-size: var(--size-0);
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
    color: var(--neutral-50);
  }

  .nav__link:hover,
  .nav__link:focus {
    background-color: var(--primary-700);
  }

  .nav__link--active {
    background-color: var(--primary-800);
  }

  /* Dropdown icon */
  .dropdown-icon {
    transition: transform 0.2s ease;
  }

  .has-dropdown:hover .dropdown-icon,
  .has-dropdown.open .dropdown-icon {
    transform: rotate(180deg);
  }

  /* Dropdown Menu */
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 200px;
    background-color: var(--primary-800);
    border: 1px solid var(--primary-700);
    border-radius: 8px;
    padding: var(--space-2xs) 0;
    margin-top: var(--space-3xs);
    list-style: none;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    z-index: 200;
  }

  /* Show dropdown on hover (desktop) */
  .has-dropdown:hover .dropdown-menu,
  .has-dropdown.open .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-link {
    display: block;
    padding: var(--space-xs) var(--space-m);
    color: var(--neutral-100);
    text-decoration: none;
    font-size: var(--size--1);
    transition: all 0.15s ease;
    white-space: nowrap;
  }

  .dropdown-link:hover,
  .dropdown-link:focus {
    background-color: var(--primary-700);
    color: var(--neutral-50);
  }

  .dropdown-link--active {
    background-color: var(--primary-600);
    color: var(--neutral-50);
    font-weight: 500;
  }

  /* Mobile Adjustments */
  @media (max-width: 63.99875em) {
    .header {
      border-bottom: 1px solid var(--primary-800);
    }

    .header__bar {
      padding-block: var(--space-xs);
    }

    .header__content {
      gap: var(--space-m);
    }

    .logo-desktop {
      display: none;
    }
    
    .logo-mobile {
      display: inline-block;
    }

    .nav__link {
      padding: var(--space-2xs) var(--space-xs);
      font-size: var(--size--1);
    }

    .nav {
      position: relative;
      overflow: visible;
    }

    .nav::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 30px;
      background: linear-gradient(to right, transparent, var(--primary-900));
      pointer-events: none;
      z-index: 10;
    }

    /* Dropdown en m칩vil - se abre con tap */
    .dropdown-menu {
      position: absolute;
      left: 0;
      right: auto;
      min-width: 180px;
    }

    .dropdown-link {
      padding: var(--space-xs) var(--space-s);
    }

    /* Evitar que el dropdown se corte */
    .has-dropdown:last-child .dropdown-menu,
    .has-dropdown:nth-last-child(2) .dropdown-menu {
      left: auto;
      right: 0;
    }
  }

  /* Animaci칩n sutil al hacer scroll */
  @media (prefers-reduced-motion: no-preference) {
    .nav__list {
      scroll-snap-type: x proximity;
    }

    .nav__list li {
      scroll-snap-align: start;
    }
  }

  /* Focus visible para accesibilidad */
  .nav__link:focus-visible,
  .dropdown-link:focus-visible {
    outline: 2px solid var(--primary-400);
    outline-offset: 2px;
  }
</style>

<script>
  // Manejo de dropdowns para mobile (tap) y desktop (hover)
  const dropdownItems = document.querySelectorAll('.has-dropdown');
  
  dropdownItems.forEach((item) => {
    const button = item.querySelector('.nav__link--dropdown');
    
    if (button) {
      // Toggle en click/tap para m칩vil
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isOpen = item.classList.contains('open');
        
        // Cerrar otros dropdowns
        dropdownItems.forEach((otherItem) => {
          if (otherItem !== item) {
            otherItem.classList.remove('open');
            const otherButton = otherItem.querySelector('.nav__link--dropdown');
            if (otherButton) {
              otherButton.setAttribute('aria-expanded', 'false');
            }
          }
        });
        
        // Toggle actual
        item.classList.toggle('open');
        button.setAttribute('aria-expanded', !isOpen ? 'true' : 'false');
      });
    }
  });

  // Cerrar dropdowns al hacer click fuera
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (!target.closest('.has-dropdown')) {
      dropdownItems.forEach((item) => {
        item.classList.remove('open');
        const button = item.querySelector('.nav__link--dropdown');
        if (button) {
          button.setAttribute('aria-expanded', 'false');
        }
      });
    }
  });

  // Cerrar con Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      dropdownItems.forEach((item) => {
        item.classList.remove('open');
        const button = item.querySelector('.nav__link--dropdown');
        if (button) {
          button.setAttribute('aria-expanded', 'false');
        }
      });
    }
  });

  // Scroll indicator
  const navList = document.querySelector('.nav__list') as HTMLElement;
  
  if (navList) {
    function updateScrollIndicator() {
      const isScrollable = navList.scrollWidth > navList.clientWidth;
      const isAtEnd = navList.scrollLeft >= (navList.scrollWidth - navList.clientWidth - 10);
      
      if (isScrollable && !isAtEnd) {
        navList.classList.add('has-more-content');
      } else {
        navList.classList.remove('has-more-content');
      }
    }

    navList.addEventListener('scroll', updateScrollIndicator);
    window.addEventListener('resize', updateScrollIndicator);
    updateScrollIndicator();
  }
</script>